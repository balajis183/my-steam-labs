<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Blockly Code Generator</title>
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script src="./custom_blocks.js"></script>
    <link rel="stylesheet" href="./style.css" />

    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
        font-family: sans-serif;
      }

      #navbar-placeholder {
        width: 100%;
      }

      #topbar {
        padding: 10px;
        background: #f0f0f0;
        border-bottom: 1px solid #ccc;
        width: 100%;
        box-sizing: border-box;
      }

      #main {
        display: flex;
        width: 100%;
        height: calc(100vh - 50px); /* fallback, updated dynamically */
      }

      #blocklyDiv {
        height: 100%;
        width: 70%;
        position: relative;
        background: #fff;
      }

      #codeArea {
        width: 30%;
        height: 100%;
        padding: 10px;
        background: #fafafa;
        border-left: 1px solid #ccc;
        box-sizing: border-box;
      }

      button {
        margin-right: 10px;
        padding: 6px 12px;
        cursor: pointer;
      }

      iframe {
        width: 100%;
        height: 100%;
        border: none;
      }
    </style>
  </head>

  <body>
    <!-- Navbar loaded dynamically -->
    <div id="navbar-placeholder"></div>

    <!-- Toolbar -->
    <div id="topbar">
      <button onclick="generateJavaScriptCode()">Generate JavaScript</button>
      <button onclick="generatePythonCode()">Generate Python</button>
      <button onclick="generateCppCode()">Generate C++</button>
      <button onclick="generateCCode()">Generate C</button>
      <button onclick="copyCode()">Copy Code</button>
      <button id="checkConnectionBtn">Check Board Status</button>
      <div id="connection-status" style="width:15px; height:15px; border-radius:50%; background-color:grey; display:inline-block; margin-left:10px;"></div>
    </div>

    <!-- Main layout -->
    <div id="main">
      <div id="blocklyDiv"></div>
      <div id="codeArea">
        <iframe id="monacoEditor" src="monaco.html"></iframe>
      </div>
    </div>

    <!-- Blockly Toolbox -->
    <xml id="toolbox" style="display: none">
      <category name="Logic" colour="210">
        <block type="controls_if"></block>
        <block type="logic_compare"></block>
        <block type="logic_operation"></block>
        <block type="logic_negate"></block>
        <block type="logic_boolean"></block>
      </category>
      <category name="Loops" colour="120">
        <block type="controls_repeat_ext">
          <value name="TIMES">
            <block type="math_number">
              <field name="NUM">10</field>
            </block>
          </value>
        </block>
        <block type="controls_whileUntil"></block>
      </category>
      <category name="Math" colour="230">
        <block type="math_number"></block>
        <block type="math_arithmetic"></block>
      </category>
      <category name="Pin I/O" colour="230">
        <block type="set_pin"></block>
        <block type="read_pin"></block>
      </category>
      <category name="Motors" colour="20">
        <block type="dc_motor"></block>
        <block type="servo_motor"></block>
      </category>
      <category name="Sensors" colour="120">
        <block type="ldr_sensor"></block>
        <block type="ir_sensor"></block>
        <block type="temp_sensor"></block>
        <block type="ultrasonic_sensor"></block>
        <block type="touch_sensor"></block>
        <block type="color_sensor"></block>
      </category>
      <category name="Joystick" colour="290">
        <block type="joystick1"></block>
        <block type="joystick2"></block>
      </category>
      <category name="OLED Display" colour="330">
        <block type="oled_show"></block>
      </category>
      <category name="Text" colour="160">
        <block type="text"></block>
        <block type="text_print"></block>
      </category>
      <category name="Variables" colour="330" custom="VARIABLE"></category>
      <category name="Functions" colour="290" custom="PROCEDURE"></category>
    </xml>

    <script>
      let workspace;

      fetch('navbar.html')
        .then(res => res.text())
        .then(html => {
          document.getElementById('navbar-placeholder').innerHTML = html;

          // Adjust #main height after navbar loads
          requestAnimationFrame(() => {
            const navbarHeight = document.getElementById('navbar-placeholder').offsetHeight || 0;
            const topbarHeight = document.getElementById('topbar').offsetHeight || 0;
            document.getElementById('main').style.height = `calc(100vh - ${navbarHeight + topbarHeight}px)`;
            Blockly.svgResize(workspace);
          });
        });

      workspace = Blockly.inject('blocklyDiv', {
        toolbox: document.getElementById('toolbox'),
        trashcan: true,
        scrollbars: true
      });

      window.addEventListener('resize', () => Blockly.svgResize(workspace));
      Blockly.svgResize(workspace);

      function sendCodeToMonaco(code, language = 'javascript') {
        const editorWindow = document.getElementById('monacoEditor').contentWindow;
        editorWindow.postMessage({ code, language }, '*');
      }

      function copyCode() {
        const editorWindow = document.getElementById('monacoEditor').contentWindow;
        editorWindow.document.execCommand('copy');
        alert('Code copied!');
      }

      function indent(code) {
        return code.split('\n').map(line => '  ' + line.trim()).join('\n');
      }

      function generateJavaScriptCode() {
        const code = Blockly.JavaScript.workspaceToCode(workspace);
        sendCodeToMonaco(code);
      }

      function generatePythonCode() {
        const code = Blockly.JavaScript.workspaceToCode(workspace)
          .replace(/console\.log/g, 'print')
          .replace(/;/g, '')
          .replace(/\b(var|let|const)\s+/g, '')
          .replace(/\bfunction\b/g, 'def')
          .replace(/\{/g, ':')
          .replace(/\}/g, '');
        sendCodeToMonaco(code, 'python');
      }

      function generateCppCode() {
        const raw = Blockly.JavaScript.workspaceToCode(workspace);
        const code = `
#include <Arduino.h>
void setup() {
  // Setup code
}
void loop() {
${indent(raw)}
}`;
        sendCodeToMonaco(code, 'cpp');
      }

      function generateCCode() {
        const raw = Blockly.JavaScript.workspaceToCode(workspace);
        const code = `
#include <stdio.h>
int main() {
${indent(raw)}
  return 0;
}`;
        sendCodeToMonaco(code, 'c');
      }

      // Board connection status check
      const statusIndicator = document.getElementById('connection-status');
      document.getElementById('checkConnectionBtn').addEventListener('click', async () => {
        statusIndicator.style.backgroundColor = 'grey';
        const connected = await window.electronAPI?.checkConnection?.();
        statusIndicator.style.backgroundColor = connected ? 'green' : 'red';
      });
    </script>

    <script src="./renderer.js"></script>
  </body>
</html>
